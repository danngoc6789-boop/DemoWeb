@model DemoWeb.Models.Product
@{
    ViewBag.Title = "Chỉnh sửa sản phẩm";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-lg">
                <div class="card-header bg-warning text-dark">
                    <h3 class="mb-0">
                        <i class="fas fa-edit"></i> CHỈNH SỬA SẢN PHẨM
                    </h3>
                    <small class="text-muted">Mã sản phẩm: #@Model.Id</small>
                </div>
                <div class="card-body p-4">
                    @using (Html.BeginForm("Edit", "Admin", FormMethod.Post, new { enctype = "multipart/form-data", @class = "needs-validation" }))
                    {
                        @Html.AntiForgeryToken()
                        @Html.HiddenFor(m => m.Id)
                        @Html.HiddenFor(m => m.Image)
                        @Html.HiddenFor(m => m.Images)
                        @Html.HiddenFor(m => m.CreatedDate)

                        if (!ViewData.ModelState.IsValid)
                        {
                            <div class="alert alert-danger">
                                @Html.ValidationSummary(true, "Vui lòng kiểm tra lại các trường bên dưới.")
                            </div>
                        }

                        <div class="row">
                            <!-- Cột trái - Thông tin sản phẩm -->
                            <div class="col-md-8">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-info-circle text-warning"></i> Thông tin cơ bản
                                </h5>

                                <div class="form-group">
                                    <label class="font-weight-bold">
                                        Tên sản phẩm <span class="text-danger">*</span>
                                    </label>
                                    @Html.TextBoxFor(m => m.Name, new
                                    {
                                        @class = "form-control form-control-lg",
                                        required = "required"
                                    })
                                    @Html.ValidationMessageFor(m => m.Name, "", new { @class = "text-danger small" })
                                </div>

                                <div class="form-group">
                                    <label class="font-weight-bold">Mô tả chi tiết</label>
                                    @Html.TextAreaFor(m => m.Description, new
                                    {
                                        @class = "form-control",
                                        rows = "5"
                                    })
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="font-weight-bold">
                                                Danh mục <span class="text-danger">*</span>
                                            </label>
                                            @Html.TextBoxFor(m => m.Category, new
                                            {
                                                @class = "form-control",
                                                required = "required"
                                            })
                                            @if (ViewBag.Categories != null && ViewBag.Categories.Count > 0)
                                            {
                                                <small class="form-text text-muted">
                                                    Danh mục hiện có: @string.Join(", ", ViewBag.Categories)
                                                </small>
                                            }
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="font-weight-bold">Loại sản phẩm</label>
                                            @Html.TextBoxFor(m => m.Type, new
                                            {
                                                @class = "form-control"
                                            })
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="font-weight-bold">
                                                Giá bán (VNĐ) <span class="text-danger">*</span>
                                            </label>
                                            @Html.TextBoxFor(m => m.Price, new
                                            {
                                                @class = "form-control",
                                                type = "number",
                                                step = "1000",
                                                min = "0",
                                                required = "required"
                                            })
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="font-weight-bold">Giới tính</label>
                                            <select name="Gender" class="form-control">
                                                <option value="">-- Chọn giới tính --</option>
                                                <option value="Nam" @(Model.Gender == "Nam" ? "selected" : "")>👨 Nam</option>
                                                <option value="Nữ" @(Model.Gender == "Nữ" ? "selected" : "")>👩 Nữ</option>
                                                <option value="Unisex" @(Model.Gender == "Unisex" ? "selected" : "")>🧑 Unisex</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="alert alert-info">
                                    <i class="fas fa-calendar-alt"></i>
                                    <strong>Ngày tạo:</strong> @Model.CreatedDate.ToString("dd/MM/yyyy HH:mm")
                                </div>
                            </div>

                            <!-- Cột phải - Upload ảnh -->
                            <div class="col-md-4">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="fas fa-image text-warning"></i> Hình ảnh
                                </h5>

                                <div class="form-group">
                                    <label class="font-weight-bold">Ảnh hiện tại</label>

                                    <div class="text-center border rounded p-3 bg-light mb-3">
                                        @{
                                            var currentImage = !string.IsNullOrEmpty(Model.Image) ? Url.Content(Model.Image) : Url.Content("~/Content/images/no-image.png");
                                        }
                                        <img id="currentImage"
                                             src="@currentImage"
                                             alt="@Model.Name"
                                             class="img-fluid rounded shadow-sm"
                                             style="max-height: 250px; width: 100%; object-fit: contain;" />
                                    </div>

                                    <label class="font-weight-bold">Thay đổi ảnh</label>
                                    <div class="custom-file mb-3">
                                        <input type="file" name="imageFile" class="custom-file-input" id="imageFile" accept="image/*" onchange="previewImage(this)">
                                        <label class="custom-file-label" for="imageFile">Chọn ảnh mới...</label>
                                    </div>

                                    <div id="newImagePreview" class="text-center border rounded p-3 bg-white" style="display:none;">
                                        <p class="text-success"><strong>Ảnh mới:</strong></p>
                                        <img id="imagePreview"
                                             src=""
                                             alt="New Preview"
                                             class="img-fluid rounded shadow-sm"
                                             style="max-height: 250px; width: 100%; object-fit: contain;" />
                                    </div>

                                    <small class="form-text text-muted mt-2">
                                        <i class="fas fa-info-circle"></i> Để trống nếu không muốn thay đổi ảnh
                                    </small>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4" />

                        <div class="form-group mb-0">
                            <button type="submit" class="btn btn-warning btn-lg px-5 text-dark">
                                <i class="fas fa-save"></i> Cập nhật sản phẩm
                            </button>
                            <a href="@Url.Action("Products")" class="btn btn-secondary btn-lg px-4 ml-2">
                                <i class="fas fa-times"></i> Hủy bỏ
                            </a>
                            <a href="@Url.Action("Details", new { id = Model.Id })" class="btn btn-info btn-lg px-4 ml-2">
                                <i class="fas fa-eye"></i> Xem chi tiết
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        function previewImage(input) {
            if (input.files && input.files[0]) {
                // Check file size (max 5MB)
                if (input.files[0].size > 5242880) {
                    alert('File quá lớn! Vui lòng chọn ảnh dưới 5MB.');
                    input.value = '';
                    return;
                }

                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#imagePreview').attr('src', e.target.result);
                    $('#newImagePreview').show();
                }
                reader.readAsDataURL(input.files[0]);

                var fileName = input.files[0].name;
                $(input).next('.custom-file-label').html(fileName);
            }
        }
    </script>

    <style>
        .card {
            border: none;
        }

        .form-control:focus {
            border-color: #ffc107;
            box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
        }

        .custom-file-label::after {
            content: "Chọn file";
        }
    </style>
}