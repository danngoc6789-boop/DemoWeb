@model DemoWeb.Models.SupportRequest

@{
    ViewBag.Title = "Chi tiết yêu cầu hỗ trợ";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Xử lý số điện thoại cho Zalo
    var phoneClean = Model.Phone?.Replace(" ", "").Replace("-", "").Replace(".", "");
    var phoneForZalo = phoneClean;
    if (phoneForZalo?.StartsWith("0") == true)
    {
        phoneForZalo = "84" + phoneForZalo.Substring(1);
    }
}

@section Head {
    <link href="~/Content/AdminClient.css" rel="stylesheet" />
}

<div class="detail-container">

    <!-- Breadcrumb -->
    <div class="breadcrumb-box">
        <a href="@Url.Action("Index","Admin")">Dashboard</a>
        <span class="breadcrumb-sep">/</span>
        <a href="@Url.Action("Supports","Admin")">Danh sách hỗ trợ</a>
        <span class="breadcrumb-sep">/</span>
        <span>Chi tiết #@Model.Id</span>
    </div>

    <!-- Thông báo -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert-success">
            <i class="fa fa-check-circle"></i> @TempData["SuccessMessage"]
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert-error">
            <i class="fa fa-exclamation-circle"></i> @TempData["ErrorMessage"]
        </div>
    }

    <!-- Card chi tiết -->
    <div class="detail-card">
        <div class="detail-header">
            <div class="detail-title">
                Yêu cầu hỗ trợ #@Model.Id
            </div>
            <div>
                <span class="status-badge @GetStatusClass(Model.Status)">
                    <i class="fa fa-circle" style="font-size:8px;"></i> @Model.Status
                </span>
            </div>
        </div>

        <!-- Thông tin khách hàng -->
        <div class="detail-row">
            <div class="detail-label">
                <i class="fa fa-user"></i> Khách hàng:
            </div>
            <div class="detail-value">
                <strong>@Model.CustomerName</strong>
            </div>
        </div>

        <div class="detail-row">
            <div class="detail-label">
                <i class="fa fa-phone"></i> Số điện thoại:
            </div>
            <div class="detail-value">
                <a href="tel:@phoneClean" style="color: #DAA520; font-weight:500;">
                    @Model.Phone
                </a>
                <a href="https://zalo.me/@phoneForZalo" target="_blank"
                   style="margin-left: 16px; color: #0068ff;">
                    <i class="fa fa-comments"></i> Chat Zalo
                </a>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(Model.Email))
        {
            <div class="detail-row">
                <div class="detail-label">
                    <i class="fa fa-envelope"></i> Email:
                </div>
                <div class="detail-value">
                    <a href="mailto:@Model.Email" style="color: #DAA520;">
                        @Model.Email
                    </a>
                </div>
            </div>
        }

        <div class="detail-row">
            <div class="detail-label">
                <i class="fa fa-clock-o"></i> Thời gian gửi:
            </div>
            <div class="detail-value">
                <strong>@Model.CreatedAt.ToString("HH:mm:ss dd/MM/yyyy")</strong>
                <span style="color: #999; margin-left: 12px; font-size:0.9rem;">
                    (@GetTimeAgo(Model.CreatedAt))
                </span>
            </div>
        </div>

        <div class="detail-row">
            <div class="detail-label">
                <i class="fa fa-comment"></i> Nội dung:
            </div>
            <div class="detail-value">
                <div class="message-box">@Model.Message</div>
            </div>
        </div>

        <!-- Nút hành động -->
        <div class="action-buttons">

            <!-- Cập nhật trạng thái -->
            @if (Model.Status != "Đã xử lý")
            {
                <!-- Đang xử lý -->
                if (Model.Status == "Chờ xử lý")
                {
                    using (Html.BeginForm("UpdateSupportStatus", "Admin", new { id = Model.Id }, FormMethod.Post, new { @class = "status-update-form" }))
                    {
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="status" value="Đang xử lý" />
                        <button type="submit" class="btn-action btn-info">
                            <i class="fa fa-spinner"></i> Đánh dấu đang xử lý
                        </button>
                    }
                }

                <!-- Hoàn thành -->
                using (Html.BeginForm("UpdateSupportStatus", "Admin", new { id = Model.Id }, FormMethod.Post, new { @class = "status-update-form" }))
                {
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="status" value="Đã xử lý" />
                    <button type="submit" class="btn-action btn-success">
                        <i class="fa fa-check"></i> Đánh dấu đã xử lý
                    </button>
                }
            }

            <!-- Gọi điện -->
            <a href="tel:@phoneClean" class="btn-action btn-primary">
                <i class="fa fa-phone"></i> Gọi điện
            </a>

            <!-- Chat Zalo -->
            <a href="https://zalo.me/@phoneForZalo" target="_blank" class="btn-action btn-info">
                <i class="fa fa-comments"></i> Chat Zalo
            </a>

            <!-- Quay lại -->
            <a href="@Url.Action("Supports","Admin")" class="btn-action btn-secondary">
                <i class="fa fa-arrow-left"></i> Quay lại danh sách
            </a>

            <!-- Xóa -->
            <button type="button" class="btn-action btn-danger" onclick="confirmDelete()">
                <i class="fa fa-trash"></i> Xóa yêu cầu
            </button>
        </div>
    </div>

    <!-- Form xóa ẩn -->
    @using (Html.BeginForm("DeleteSupport", "Admin", new { id = Model.Id }, FormMethod.Post, new { id = "deleteForm", style = "display:none;" }))
    {
        @Html.AntiForgeryToken()
    }
</div>

@section Scripts {
    <script>
        function confirmDelete() {
            if (confirm('Bạn có chắc chắn muốn xóa yêu cầu hỗ trợ này?\nHành động này không thể hoàn tác!')) {
                document.getElementById('deleteForm').submit();
            }
        }
    </script>
}

@functions {
    string GetStatusClass(string status)
    {
        switch (status?.ToLower())
        {
            case "chờ xử lý":
                return "status-pending";
            case "đang xử lý":
                return "status-processing";
            case "đã xử lý":
            case "hoàn thành":
                return "status-completed";
            default:
                return "status-viewed";
        }
    }

    string GetTimeAgo(DateTime dateTime)
    {
        var timeSpan = DateTime.Now - dateTime;

        if (timeSpan.TotalMinutes < 1)
            return "vừa xong";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes} phút trước";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours} giờ trước";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays} ngày trước";
        if (timeSpan.TotalDays < 30)
            return $"{(int)(timeSpan.TotalDays / 7)} tuần trước";
        if (timeSpan.TotalDays < 365)
            return $"{(int)(timeSpan.TotalDays / 30)} tháng trước";

        return dateTime.ToString("dd/MM/yyyy");
    }
}